<!doctype html>
<!--[if lt IE 7]>      <html class ="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class ="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class ="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Solar Inverter Admin</title>
    <meta name="description" content="Solar Inverter Admin">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="apple-touch-icon" href="apple-icon.png">
    <link rel="shortcut icon" href="favicon.ico">

    <link rel="stylesheet" href="vendors/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="vendors/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="vendors/themify-icons/css/themify-icons.css">
    <link rel="stylesheet" href="vendors/flag-icon-css/css/flag-icon.min.css">
    <link rel="stylesheet" href="vendors/selectFX/css/cs-skin-elastic.css">
    <link rel="stylesheet" href="vendors/jqvmap/dist/jqvmap.min.css">


    <link rel="stylesheet" href="assets/css/style.css">

    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

</head>

<body>

    <div id="right-panel" class="right-panel">

        <div class="content mt-3">


            <div class="col-sm-6 col-lg-3">
                <div class="card text-white bg-flat-color-1">
                    <div class="card-body pb-0">

                        <h4 class="mb-0">
                            <span class="count" id="pv_power">0</span>
                        </h4>
                        <p class="text-light">Solar Watt</p>

                        <div class="chart-wrapper px-0" style="height:70px;" height="70">
                            <canvas id="widgetChart1"></canvas>
                        </div>

                    </div>

                </div>
            </div>
            <!--/.col-->

            <div class="col-sm-6 col-lg-3">
                <div class="card text-white bg-flat-color-2">
                    <div class="card-body pb-0">

                        <h4 class="mb-0">
                            <span class="count" id="batteryPercent">0</span>
                        </h4>
                        <p class="text-light">Batt. Percent</p>

                        <div class="chart-wrapper px-0" style="height:70px;" height="70">
                            <canvas id="widgetChart2"></canvas>
                        </div>

                    </div>
                </div>
            </div>
            <!--/.col-->

            <div class="col-sm-6 col-lg-3">
                <div class="card text-white bg-flat-color-3">
                    <div class="card-body pb-0">

                        <h4 class="mb-0">
                            <span class="count" id="totalOutput">0</span>
                        </h4>
                        <p class="text-light">Total Output Watt</p>

                    </div>

                    <div class="chart-wrapper px-0" style="height:70px;" height="70">
                        <canvas id="widgetChart3"></canvas>
                    </div>
                </div>
            </div>
            <!--/.col-->

            <div class="col-sm-6 col-lg-3">
                <div class="card text-white bg-flat-color-4">
                    <div class="card-body pb-0">

                        <h4 class="mb-0">
                            <span id="ac_out_percent">2.6</span>
                        </h4>
                        <p class="text-light">Total Output %</p>

                        <div class="chart-wrapper px-3" style="height:70px;" height="70">
                            <canvas id="widgetChart4"></canvas>
                        </div>

                    </div>
                </div>
            </div>
            <!--/.col-->


            <div class="col-xl-6">
                <div class="card">
                    <div class="card-body">

                        <!--/.row-->
                        <div class="chart-wrapper mt-4">
                            <canvas id="trafficChart" style="height:200px;" height="200"></canvas>
                        </div>

                    </div>

                </div>
            </div>

            <div class="col-xl-3 col-lg-6">
                <div class="card">

                    <div class="Vector-map-js">
                        <img id="sunmap" class="fw">
                    </div>
                </div>
                <!-- /# card -->
            </div>


            <div class="col-xl-3 col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <div class="stat-widget-one">
                            <div class="stat-icon dib"><i class="ti-pulse text-success border-success"></i></div>
                            <div class="stat-content dib">
                                <div class="stat-text">Inverter Temperature</div>
                                <div class="stat-digit" id="inverterTemperature">25</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div class="col-xl-3 col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <div class="stat-widget-one">

                            <div class="stat-icon dib"><i class="fa fa-yelp text-primary border-primary"></i></div>

                            <div class="stat-content dib">
                                <div class="stat-text">FanSpeed %</div>
                                <div class="stat-digit" id="fanSpeed">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <div class="stat-widget-one">
                            <div class="stat-icon dib"><i class="fa fa-gears text-warning border-warning"></i></div>
                            <div class="stat-content dib">
                                <div class="stat-text">Inverter Mode</div>
                                <div class="stat-digit" id="ivmode">Battery</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-lg-6">
                <div class="card">
                    <div class="card-body">
                        <div class="stat-widget-one">
                            <div class="stat-icon dib"><i class="fa fa-bolt text-warning border-warning"></i></div>
                            <div class="stat-content dib">
                                <div class="stat-text">Inverter Charge Stage</div>
                                <div class="stat-digit" id="Inverter_charge_state">770</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div class="col-xl-3 col-lg-3">
                <section class="card">
                    <div class="twt-feed blue-bg">
                        <div class="corner-ribon black-ribon">
                            <i class="fa fa-flash"></i>
                        </div>
                        <div class="fa fa-flash wtt-mark"></div>

                        <div class="media">
                            <a href="#">
                                <img class="align-self-center rounded-circle mr-3" style="width:85px; height:85px;"
                                    alt="" src="images/admin.jpg">
                            </a>
                            <div class="media-body">
                                <h2 class="text-white display-6">Homage 5014SCC</h2>
                                <p class="text-light">Off Grid Solar</p>
                            </div>
                        </div>
                    </div>
                    <div class="weather-category">
                        <!-- <div class="stat-text">Solar</div> -->
                        <ul>
                            <li class="active">
                                <h5 id="solarWatt">750</h5>
                                Solar Watt
                            </li>
                            <li>
                                <h5 id="solarVolt">360</h5>
                                Solar Volt
                            </li>
                            <li>
                                <h5 id="solarCurrent">3</h5>
                                Solar Amp
                            </li>
                        </ul>
                    </div>

                    <div class="weather-category">
                        <!-- <div class="stat-text">Battery</div> -->
                        <ul>
                            <li class="active">
                                <h5 id="batteryWatt">750</h5>
                                Batt Watt
                            </li>
                            <li>
                                <h5 id="batteryVolt">360</h5>
                                Batt Volt
                            </li>
                            <li>
                                <h5 id="batteryCurrent">3</h5>
                                Batt Amp
                            </li>
                        </ul>
                    </div>

                    <div class="weather-category">
                        <!-- <div class="stat-text">Output Line</div> -->
                        <ul>
                            <li class="active">
                                <h5 id="lineWatt">750</h5>
                                Out Watt
                            </li>
                            <li>
                                <h5 id="lineVolt">360</h5>
                                Out Volt (AC)
                            </li>
                            <li>
                                <h5 id="lineFrequency">3</h5>
                                Out Frequency
                            </li>
                        </ul>
                    </div>

                </section>
            </div>







        </div> <!-- .content -->
    </div><!-- /#right-panel -->

    <!-- Right Panel -->

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script src="vendors/popper.js/dist/umd/popper.min.js"></script>
    <script src="vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="assets/js/main.js"></script>


    <script src="vendors/chart.js/dist/Chart.bundle.min.js"></script>
    <!-- <script src="assets/js/dashboard.js"></script>
    <script src="assets/js/widgets.js"></script>
    <script src="vendors/jqvmap/dist/jquery.vmap.min.js"></script>
    <script src="vendors/jqvmap/examples/js/jquery.vmap.sampledata.js"></script>
    <script src="vendors/jqvmap/dist/maps/jquery.vmap.world.js"></script> -->


    <script>
        // Get the current date and time
        jQuery(document).ready(function () {
            initWebSocket();
            // Set up a timer to refresh the image every 10 minutes
            updateImage();
            setInterval(updateImage, 600000); // 600000 milliseconds = 10 minutes
            
        });


        // Function to update the image source
        function updateImage() {
            let currentDate = new Date();
            let year = currentDate.getFullYear();
            let month = String(currentDate.getMonth() + 1).padStart(2, '0'); // Month is zero-based
            let day = String(currentDate.getDate()).padStart(2, '0');
            let hours = String(currentDate.getHours() - 5).padStart(2, '0');
            let minutes = String(currentDate.getMinutes()).padStart(2, '0');

            // Format the date and time in the required format
            let formattedDateTime = `${year}${month}${day}T${hours}${minutes}`;

            // Update the image src attribute with the new URL
            let imageUrl = `https://www.timeanddate.com/scripts/sunmap.php?iso=${formattedDateTime}`;
            document.getElementById('sunmap').src = imageUrl;
        }

        function createChartDB(chartId, label, borderColor, type) {
            var ctx = document.getElementById("trafficChart");
            ctx.height = 200;

            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'PV Charging Power',
                            data: [],
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Battery Power',
                            data: [],
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Total Output',
                            data: [],
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'AC Out Percent',
                            data: [],
                            backgroundColor: 'rgba(255, 206, 86, 0.2)',
                            borderColor: 'rgba(255, 206, 86, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        },
                        x: {
                            display: false
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Solar Power System'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        var chartDB = createChartDB();
        function updateChartDB(pvPower, batteryPercent, totalOutput, acOutPercent) {
            chartDB.data.labels.push(new Date().toLocaleTimeString());
            chartDB.data.datasets[0].data.push(pvPower);
            chartDB.data.datasets[1].data.push(batteryPercent);
            chartDB.data.datasets[2].data.push(totalOutput);
            chartDB.data.datasets[3].data.push(acOutPercent);

            if (chartDB.data.labels.length > 60) {
                chartDB.data.labels.shift();
                chartDB.data.datasets[0].data.shift();
                chartDB.data.datasets[1].data.shift();
                chartDB.data.datasets[2].data.shift();
                chartDB.data.datasets[3].data.shift();
            }

            chartDB.update();
        }

        function createChart(chartId) {
            var ctx = document.getElementById(chartId).getContext('2d');
            return new Chart(ctx, {
                type: 'line',
                data: {

                    type: 'line',
                    datasets: [{
                        data: [],
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {

                    maintainAspectRatio: false,
                    legend: {
                        display: false
                    },
                    responsive: true,
                    scales: {
                        xAxes: [{
                            gridLines: {
                                color: 'transparent',
                                zeroLineColor: 'transparent'
                            },
                            ticks: {
                                fontSize: 2,
                                fontColor: 'transparent'
                            }
                        }],
                        yAxes: [{
                            display: false,
                            ticks: {
                                display: false,
                            }
                        }]
                    },
                    title: {
                        display: false,
                    },
                    elements: {
                        line: {
                            borderWidth: 1
                        },
                        point: {
                            radius: 4,
                            hitRadius: 10,
                            hoverRadius: 4
                        }
                    }
                }
            });
        }

        var charts = {
            widgetChart1: createChart('widgetChart1'),
            widgetChart2: createChart('widgetChart2'),
            widgetChart3: createChart('widgetChart3'),
            widgetChart4: createChart('widgetChart4')
        };

        function updateChart(chart, value) {
            chart.data.labels.push(new Date().toLocaleTimeString());
            chart.data.datasets[0].data.push(value);

            if (chart.data.labels.length > 30) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }

            chart.update();
        }



        var gateway = `ws://hw-blockd4h6a.nayatel.net:7777/ws`;
        var websocket;
        function initWebSocket() {
            //console.log('Trying to open a WebSocket connection...');
            websocket = new WebSocket(gateway);
            websocket.onopen = onOpen;
            websocket.onclose = onClose;
            websocket.onerror = onError;
            websocket.onmessage = onMessage;
        }
        function onOpen(event) {
            console.log('Connection opened');
            setInterval(checkWS, 5000);
        }
        function onClose(event) {
            //document.getElementById("status").innerHTML = 'WS Closed';
            console.log('Connection closed');
            setTimeout(initWebSocket, 3000);
        }
        function onError(event) {
            //document.getElementById("status").innerHTML = 'WS Lost';
            console.log('Connection lost');
        }

        function onMessage(event) {
            var data = JSON.parse(event.data);
            // document.getElementById("packSOC").innerHTML = data.Battery_Percent + '%%';



            // $('#packSOC').width(data.Battery_Percent + '%%').attr('aria-valuenow', data.Battery_Percent);

            document.getElementById("solarVolt").innerHTML = data.PV_Input_Voltage + 'V ';
            document.getElementById("solarCurrent").innerHTML = data.PV_Input_Current + 'A  ';
            document.getElementById("solarWatt").innerHTML = Math.round(data.PV_Input_Current * data.PV_Input_Voltage);

            document.getElementById("pv_power").innerHTML = Math.round(data.PV_Charging_Power) + 'W  ';

            // document.getElementById("pv2_volt").innerHTML = data.PV2_Input_Voltage + 'V ';
            // document.getElementById("pv2_current").innerHTML = data.PV2_Input_Current + 'A  ';
            // document.getElementById("pv2_power").innerHTML = Math.round(data.PV2_Charging_Power) + 'W  ';

            // document.getElementById("grid_volt").innerHTML = data.AC_in_Voltage + 'V ';
            // document.getElementById("grid_hz").innerHTML = data.AC_in_Frequenz + 'Hz  ';

            // document.getElementById("ac_out_volt").innerHTML = data.AC_out_Voltage + 'V ';
            // document.getElementById("ac_out_hz").innerHTML = data.AC_out_Frequenz + 'Hz ';

            document.getElementById("totalOutput").innerHTML = data.AC_out_Watt;
            document.getElementById("ac_out_percent").innerHTML = data.AC_out_percent;

            document.getElementById("inverterTemperature").innerHTML = data.Inverter_Bus_Temperature;
            document.getElementById("fanSpeed").innerHTML = data.Fan_speed;


            document.getElementById("batteryPercent").innerHTML = data.Battery_Percent;

            document.getElementById("batteryVolt").innerHTML = data.Battery_Voltage;
            document.getElementById("batteryCurrent").innerHTML = data.Battery_Load;
            document.getElementById("batteryWatt").innerHTML = Math.round(data.Battery_Load * data.Battery_Voltage);

            document.getElementById("lineVolt").innerHTML = data.AC_out_Voltage;
            document.getElementById("lineFrequency").innerHTML = data.AC_out_Frequenz;
            document.getElementById("lineWatt").innerHTML = data.AC_out_Watt;

            document.getElementById("ivmode").innerHTML = data.Inverter_Operation_Mode;

            document.getElementById("Inverter_charge_state").innerHTML = data.Inverter_charge_state;


            var jsonString = JSONstringify(event.data);
            // document.getElementById("completeInfo").innerHTML = jsonString;
            updateChart(charts.widgetChart1, data.PV_Charging_Power);
            updateChart(charts.widgetChart2, data.Battery_Percent);
            updateChart(charts.widgetChart3, data.AC_out_Watt);
            updateChart(charts.widgetChart4, data.AC_out_percent);

            updateChartDB(data.PV_Charging_Power, Math.round(data.Battery_Load * data.Battery_Voltage), data.AC_out_Watt, data.AC_out_percent);
        }
        function checkWS() {
            if (websocket.readyState !== WebSocket.CLOSED) {
                websocket.send("A9");
            }
        }

        function JSONstringify(json) {
            if (typeof json != 'string') {
                json = JSON.stringify(json, undefined, '\t');
            }

            var
                arr = [],
                _string = 'color:green',
                _number = 'color:darkorange',
                _boolean = 'color:blue',
                _null = 'color:magenta',
                _key = 'color:red';

            json = json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                var style = _number;
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        style = _key;
                    } else {
                        style = _string;
                    }
                } else if (/true|false/.test(match)) {
                    style = _boolean;
                } else if (/null/.test(match)) {
                    style = _null;
                }
                arr.push(style);
                arr.push('');
                return '%c' + match + '%c';
            });

            arr.unshift(json);

            console.log.apply(console, arr);
            return arr;
        }



    </script>

</body>

</html>